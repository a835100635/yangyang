<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="index.css">
  <script src="https://unpkg.com/vue@3.2.12/dist/vue.global.js"></script>
  <title></title>
</head>
<body>
  <div id="app">
    <!-- <h1>Á¨¨ {{ level }} ÂÖ≥</h1> -->
    <header>
      <!-- <span class="btn" @click="handleStart">ÂºÄÂßãÊ∏∏Êàè</span> -->
      <!-- <span class="btn" @click="handleReset">ÈáçÁΩÆ</span> -->
      <!-- <span class="btn" @click="handleSwitch('prev')">‰∏ä‰∏ÄÂÖ≥</span>
      <span class="btn" @click="handleSwitch('next')">‰∏ã‰∏ÄÂÖ≥</span> -->
      <span class="btn" @click="handleStart">--</span>
      <span class="btn" @click="handleReset">==</span>
      <span class="btn" @click="handleSwitch('prev')">1</span>
      <span class="btn" @click="handleSwitch('next')">2</span>
    </header>
    <!-- ÂÆπÂô® -->
    <div class="wrap">
      <div class="container">
        <div class="card" 
          v-for="(item, index) in cards" 
          :key="index" 
          :style="setCardStyle(item)" 
          :class="[item.not && 'is-allow', item.id]"
          @click="clickCard(item, index)"
        >
          <span>{{ item.icon }}</span>
        </div>
      </div>
    </div>
    <!-- Âç°ÊßΩ -->
    <div class="card-slot"></div>
  </div>
  <script>
    const randomString = (len) => {
        const pool = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let res = '';
        while (len > 0) {
            res += pool[Math.floor(pool.length * Math.random())];
            len--;
        }
        return res;
    }
    // Â∏∏Èáè
    const constants = {
      base: 60,
      selectMaxLength: 8
    }

    const { reactive, toRefs, setup, computed, onMounted } = Vue;
    const App = {
      setup() {

        onMounted(() => {
          const containerDom = document.querySelector('.container');
          data.containerInfo = containerDom.getClientRects()[0];
          const cardSlotDom = document.querySelector('.card-slot');
          data.cardSlotInfo = cardSlotDom.getClientRects()[0];
        })
        // ÂÆπÂô®ÂÅèÁßªÈáè
        const containerOffset = computed(() => {
          const { x = 0, y = 0, width = 0, height = 0 } = data.containerInfo;
          return {
            minX: x,
            maxX: x + width,
            minY: y,
            maxY: y + height
          }
        })

        const data = reactive({
          level: 1,
          cards: [],
          select: [],
          containerInfo: null,
          cardSlotInfo: null
        });
        // Âç°ÁâáÈªòËÆ§ÂÅèÁßªÂÄº
        const offsetDefaultValue = [0, 20, -20, 40, -40];
        const offsetDefaultValueLength = offsetDefaultValue.length;

        // Âç°ÁâáÈªòËÆ§ÂõæÊ†á
        const defaultIcons = ['üêë','üòÄ', 'üò≠', 'üòÇ', 'üòç', 'üòé', 'üòò', 'üò≥', 'üòá', 'ü§™'];
        const icons = computed(() => {
          return defaultIcons.slice(0, 2 * data.level);
        })

        // Âç°ÁâáÈªòËÆ§ÁîüÊàê3ÁöÑÂÄçÊï∞
        const defaultRounds = [3, 6, 9];

        // ÂàõÂª∫Âç°ÁâáÂ±ûÊÄßÈõÜÂêà
        const createCardInfo = (icon) => {
          // ÂÅèÁßª
          const offset = offsetDefaultValue[Math.floor(offsetDefaultValueLength * Math.random())];
          // ÈöèÊú∫8Âàó 8Ë°å
          const row = Math.floor(Math.random() * 8);
          const col = Math.floor(Math.random() * 8);

          let x = col * constants.base + offset;
          let y = row * constants.base + offset;
          
          data.cards.push({
            id: randomString(6),
            icon,
            x,
            y,
            not: true,
            status: 0
          })
        }

        
        // ÂàùÂßãÂåñ
        const init = () => {
          console.log('init---', icons.value );
          data.select = [];
          for(const i in icons.value) {
            // ÈöèÊú∫3ÁöÑÂÄçÊï∞
            const rounds = defaultRounds[Math.floor(Math.random() * 3)];
            for(let k = 0; k < rounds; k++) {
              createCardInfo(icons.value[i]);
            }
          }
          checkShading();
        }

        const handleStart = () => {
          if(data.cards.length) {
              window.alert('Ê∏∏Êàè‰∏≠');
              return;
          }
          init();
        }

        // ËÆæÁΩÆÂç°ÁâáÊ†∑Âºè
        const setCardStyle = ({ x, y }) => {
          return `
            transform: translateX(${x}px) translateY(${y}px);
          `;
        }

        // ÂàáÊç¢ÂÖ≥Âç°
        const handleSwitch = (type) => {
          if(type === 'prev') {
            if(data.level === 1) {
              window.alert('Â∑≤ÁªèÊòØÁ¨¨‰∏ÄÂÖ≥‰∫Ü');
              return;
            }
            data.level--;
          } else {
            if(data.level === 10) {
              window.alert('Â∑≤ÁªèÊòØÊúÄÂêé‰∏ÄÂÖ≥‰∫Ü');
              return;
            }
            data.level++;
          }
          handleReset();
        }

        // ÈáçÁΩÆÊ∏∏Êàè
        const handleReset = () => {
          // Ê∏ÖÁ©∫Â∑≤ÊúâÁöÑÂç°Áâá
          data.cards.length = 0;
          init();
        }

        // ÊòØÂê¶ËÉΩÁÇπÂáª ÊòØÂê¶ÊúâÈò¥ÂΩ±
        const checkShading = () => {
          const cards = data.cards.slice();
          for (let i = 0; i < cards.length; i++) {
            const cur = cards[i];
            cur.not = true;
            if (cur.status !== 0) continue;
            const { x: x1, y: y1 } = cur;
            const x2 = x1 + constants.base,
                y2 = y1 + constants.base;

            for (let j = i + 1; j < cards.length; j++) {
              if (cur.status !== 0) continue;
              const compare = cards[j];
              const { x, y } = compare;
              if (!(y + constants.base <= y1 || y >= y2 || x + constants.base <= x1 || x >= x2)) {
                  cur.not = false;
                  break;
              }
            }
          }
        }

        // Âà∑Êñ∞Âç°ÊßΩÂç°Áâá‰ΩçÁΩÆ
        const refreshCardPosition = (item) => {
          const length = data.select.length;
          const { x, y } = data.cardSlotInfo;
          const { top } = data.containerInfo;

          let lastIndex = length - 1;
          console.log('--', JSON.parse(JSON.stringify(data.select)));
          data.select.forEach((i, index) => {
            console.log('item.icon === i.icon', item.icon, i.icon,  item.icon === i.icon, index);
            if(item.icon === i.icon) {
              lastIndex  = index;
            }
          })
          console.log('lastIndex', lastIndex);

          if(length){
            for (let i = lastIndex + 1; i < length; i++) {
              data.select[i].x += 60;
            }
          }
          item.x = x + lastIndex * 60;
          item.y = y - top + 10;
        }

        const clickCard = async (item, index) => {
          const length = data.select.length;
          const { selectMaxLength } = constants;
          if(item.not && length < selectMaxLength) {
            const cards = data.cards.slice();
            const currentCard = cards[index];
            currentCard.status = 1;

            // Âà∑Êñ∞Âç°ÊßΩ‰ΩçÁΩÆ
            await refreshCardPosition(currentCard);

            data.select.push(currentCard);

            // Âà∑Êñ∞Ë¢´ÈÅÆÊå°Âç°Áâá
            checkShading();
          };

          // Ê†°È™åÂç°ÁâáÂç°ÊßΩÂç°ÁâáÊï∞ÈáèÈïøÂ∫¶
          if(data.select.length >= 8) {
            console.log('Â§±Ë¥•');
          }
        }

        const dataRefs = toRefs(data);
        return {
          ...dataRefs,
          handleStart,
          setCardStyle,
          handleSwitch,
          handleReset,
          clickCard
        }
      }
    }
    Vue.createApp(App).mount('#app');
  </script>
</body>
</html>